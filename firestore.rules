rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Preferred: Users stored by uid (one document per user)
    match /users_uid/{userId} {
      // only the authenticated owner may read or write their profile
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // Legacy / email-keyed users - allow creation/updates only by the authenticated owner
    // This permits older client code that writes to `users/{email}` during registration.
    match /users/{emailId} {
      // allow create when the incoming document explicitly claims the authenticated user's uid or email
      allow create: if request.auth != null && (
        (request.resource.data.uid != null && request.resource.data.uid == request.auth.uid)
        || (request.resource.data.email != null && request.resource.data.email == request.auth.token.email)
      );

      // allow read/update/delete only if the stored document belongs to the authenticated user
      allow read, update, delete: if request.auth != null && (
        (resource.data.uid != null && resource.data.uid == request.auth.uid)
        || (resource.data.email != null && resource.data.email == request.auth.token.email)
      );
    }

    // Carts stored by uid: only the owner may read or modify their cart
    match /carts/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // Orders: authenticated users may create orders (must include their uid), and may read only their own orders
    match /orders/{orderId} {
      allow create: if request.auth != null && request.resource.data.uid == request.auth.uid;
      allow read: if request.auth != null && resource.data.uid == request.auth.uid;
      // no updates / deletes allowed from client-side by default
      allow update, delete: if false;
    }

    // Inventory is public read-only for the frontend
    match /inventory/{doc} {
      allow read: if true;
      // restrict direct inventory writes from client apps
      allow write: if false;
    }

    // Deny everything else by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
